################################################################################
# CONNECTION SETTINGS
################################################################################

# Listen on all network interfaces (allows remote connections)
# Use security groups to control actual access
listen_addresses = '*'

# Default PostgreSQL port
port = 5432

# Maximum number of concurrent connections
# Template variable - adjust based on workload
# Formula: (RAM in GB Ã— 10-20) or based on connection pool size
max_connections = ${max_connections}

# Reserved connections for superuser access (emergency access)
# Ensures you can always connect as postgres even when max_connections is reached
superuser_reserved_connections = 3

################################################################################
# MEMORY SETTINGS
################################################################################

# Shared memory buffer pool for caching data
# Template variable - recommended: 25% of total RAM
# Used for caching table data and indexes
# Example: 2GB for 8GB RAM instance
shared_buffers = ${shared_buffers}

# Estimate of memory available for disk caching by OS
# Template variable - recommended: 75% of total RAM
# Used by query planner to estimate cost of index scans
# Example: 6GB for 8GB RAM instance
effective_cache_size = ${effective_cache_size}

# Memory for maintenance operations (VACUUM, CREATE INDEX, ALTER TABLE)
# Higher values speed up maintenance operations
# Recommended: 5-10% of RAM, but not more than 1GB per worker
maintenance_work_mem = 512MB

# Memory for each query operation (sorts, hash tables, etc.)
# Too high: Risk of OOM if many concurrent queries
# Too low: Spills to disk (slower)
# Recommended: 1-4% of RAM divided by max_connections
work_mem = 16MB

################################################################################
# WRITE-AHEAD LOG (WAL) SETTINGS
################################################################################

# WAL level: minimal (no replication, fastest for standalone)
# Options: minimal, replica (for replication), logical (for logical decoding)
# Using minimal since this is a standalone database
wal_level = minimal

# Memory buffer for WAL data before writing to disk
# Default is typically sufficient, larger values reduce I/O
wal_buffers = 16MB

# Maximum size of WAL between automatic checkpoints
# Larger values: Less frequent checkpoints, more recovery time after crash
# Recommended: 1-4GB for production
max_wal_size = 1GB

# Minimum size to keep WAL files for reuse
# Helps avoid constant file creation/deletion
min_wal_size = 256MB

# Checkpoint completion target as fraction of checkpoint interval
# 0.9 means spread checkpoint writes over 90% of checkpoint interval
# Prevents I/O spikes by spreading writes over time
checkpoint_completion_target = 0.9

# Archive mode: off (no WAL archiving since no replication)
# Enable if you need point-in-time recovery or replication
archive_mode = off

################################################################################
# QUERY PLANNER / OPTIMIZER
################################################################################

# Cost of non-sequential disk page fetch (lower = faster storage)
# 1.1 is optimized for SSD (default 4.0 is for HDD)
# Lower values encourage index scans over sequential scans
random_page_cost = 1.1

# Number of concurrent disk I/O operations
# For SSD/NVMe: 200 is good, for HDD: 2-4
# Higher values allow planner to estimate better parallel I/O
effective_io_concurrency = 200

# Default statistics target for ANALYZE
# Higher values: More accurate query plans, slower ANALYZE
# Range: 1-10000, default: 100
default_statistics_target = 100

################################################################################
# LOGGING
################################################################################

# Enable logging collector (captures stderr to log files)
# Required for log rotation and detailed log management
logging_collector = on

# Directory for log files (relative to data directory)
log_directory = 'log'

# Log file naming pattern (includes date/time for rotation)
# Creates files like: postgresql-2026-01-22_143000.log
log_filename = 'postgresql-%Y-%m-%d_%H%M%S.log'

# Rotate log files after this duration
# 1d = daily rotation (prevents huge log files)
log_rotation_age = 1d

# Rotate log files when they reach this size
# Additional size-based rotation (along with time-based)
log_rotation_size = 100MB

# Log line prefix with useful debugging info
# %t=timestamp, %p=process_id, %l=log_line_number, %u=user, %d=database, %a=application, %h=host
log_line_prefix = '%t [%p]: [%l-1] user=%u,db=%d,app=%a,client=%h '

# Timezone for log timestamps
log_timezone = 'UTC'

# Log checkpoints (useful for performance tuning)
log_checkpoints = on

# Log client connections (audit trail)
log_connections = on

# Log client disconnections (audit trail)
log_disconnections = on

# Log queries waiting for locks (helps identify lock contention)
log_lock_waits = on

# Which SQL statements to log
# Options: none, ddl, mod, all
# 'none' = use log_min_duration_statement instead
log_statement = 'none'

# Log usage of temporary files larger than this size
# 0 = log all temp file usage (helps identify queries needing optimization)
log_temp_files = 0

################################################################################
# AUTOVACUUM
################################################################################

# Enable autovacuum daemon (essential for preventing transaction ID wraparound)
# Automatically runs VACUUM and ANALYZE to maintain database health
autovacuum = on

# Maximum number of autovacuum worker processes
# Higher values: Can vacuum multiple tables concurrently
# Adjust based on number of tables and update frequency
autovacuum_max_workers = 3

# Delay between autovacuum runs on any database
# Shorter intervals: More responsive to bloat, more overhead
autovacuum_naptime = 1min

################################################################################
# LOCALE AND FORMATTING
################################################################################

# Date/time display format
# 'iso' = ISO 8601 format (YYYY-MM-DD)
datestyle = 'iso, mdy'

# Server timezone (UTC recommended for consistency)
timezone = 'UTC'

# Default text search configuration (for full-text search)
# Determines stemming rules and stop words
default_text_search_config = 'pg_catalog.english'

################################################################################
# SECURITY
################################################################################

# Enable SSL/TLS connections
# Requires SSL certificates (uses snakeoil certs by default)
ssl = on

# Password encryption method
# scram-sha-256 is most secure (better than md5)
# Requires client support for SCRAM-SHA-256
password_encryption = scram-sha-256

################################################################################
# EXTENSIONS AND MONITORING
################################################################################

# Extensions to load at server start
# pg_stat_statements: Track execution statistics of SQL statements
shared_preload_libraries = 'pg_stat_statements'

# Maximum length of query text to store in pg_stat_statements
# Longer queries need more storage but provide complete information
track_activity_query_size = 2048

# Collect timing information for I/O operations
# Helps identify slow disk operations (slight overhead)
track_io_timing = on
